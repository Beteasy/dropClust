---
title: "Batch Correction"
author: "Debajyoti Sinha"
output: github_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Batch Correction}
  %\usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval=FALSE,
  comment = "#>"
)
```

## Integrative analysis
```{r,warning=FALSE,message=FALSE}

library(dropClust)
load(url("https://raw.githubusercontent.com/LuyiTian/CellBench_data/master/data/sincell_with_class.RData"))

set.seed(0)
objects = list()

objects[[1]] = sce_sc_10x_qc

objects[[2]] = sce_sc_CELseq2_qc

objects[[3]] = sce_sc_Dropseq_qc

```

## Merge datasets using dropClust
Datasets can be merged in two ways: using a set of DE genes from each batch or, using the common set of genes from the raw count data

```{r}

all.objects = objects
merged_data<-Merge(all.objects)

annotations = merged_data$cell_line
batch.id = merged_data$Batch
```


## Perform correction and dimension reduction

```{r}
set.seed(0)
dc.corr <-  Correction(merged_data,  method="default", close_th = 0.1, cells_th = 0.1,
                       components = 10, n_neighbors = 20, init = "spca", min_dist = 0.5)
```

## Perform Clustering on integrated dimensions

```{r}
dc.corr = Cluster(dc.corr,method = "default",centers = 3)
```
## Visualizing clusters

Compute 2D embeddings for samples followed by post-hoc clustering.

```{r}
ScatterPlot(dc.corr,title = "Clusters")

PROJ_c_dc = reducedDim(dc.corr, "CComponents")
plot_proj_df_true_dc<-data.frame(Y1 = PROJ_c_dc[,1],Y2 = PROJ_c_dc[,2],
                                 color = as.factor(dc.corr$cell_line),
                                 batch = as.integer(dc.corr$Batch))
batch_plot(plot_proj_df_true_dc,filename = NA, title = "Corrected DC ",  type=NULL)
```

## Marker discovery from the merged dataset
```{r}
de<-FindMarkers(cc,q_th = 0.001, lfc_th = 1.2)
```
